var building = {
    id: "id",
    surrounding: "<svg> for surrounding goes here",
    floors: [
        {
            id: "floor_id", // we ignore this for now just go with Level X
            title: "", // do we really need this ???
            svg: '<svg class="map map--5" viewBox="0 0 1200 800" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">'
            + '<title>Map Level 1</title>'
            + '<path data-type="outline" data-item="" d="m-1.8007-3.6014,0,773.4,1030.9,0,0-772.5z"/>'
            + '<rect data-type="floor" data-item="" id="floor" height="746.3" width="1005.4" y="9.6014" x="9.2028"/>'
            + '<rect data-type="room" data-item="" id="room_1" data-space="4.01" height="341.4" width="730.38" y="27.009" x="24.108"/>'
            + '<rect data-type="appliance" data-item="" id="room_2" data-space="4.02" height="440" width="160" y="301.49" x="838.39"/>'
            + '<rect data-type="lake" data-item="" id="room_3" data-space="4.03" height="262" width="262" y="480.19" x="21.306"/>'
            + '<rect data-type="appliance" data-item="dryer" id="room_4" data-space="4.04" height="262" width="262" y="480.34" x="297.57"/>'
            + '<path data-type="tree" data-item="" id="tree" d="m798.61,559.57a75.179,75.179,0,1,1,-150.36,0,75.179,75.179,0,1,1,150.36,0z" transform="translate(-34.213365,-44.117233)"/>'
            + '</svg>'
        },
        {
            id: "floor_id", // we ignore this for now just go with Level X
            title: "", // do we really need this ???
            svg: '<svg class="map map--5" viewBox="0 0 1200 800" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">'
            + '<title>Map Level 1</title>'
            + '<path data-type="outline" data-item="" d="m-1.8007-3.6014,0,773.4,1030.9,0,0-772.5z"/>'
            + '<rect data-type="floor" data-item="" id="floor" height="746.3" width="1005.4" y="9.6014" x="9.2028"/>'
            + '<rect data-type="room" data-item="" id="room_1" data-space="4.01" height="341.4" width="730.38" y="27.009" x="24.108"/>'
            + '<rect data-type="appliance" data-item="" id="room_2" data-space="4.02" height="440" width="160" y="301.49" x="838.39"/>'
            + '<rect data-type="lake" data-item="" id="room_3" data-space="4.03" height="262" width="262" y="480.19" x="21.306"/>'
            + '<rect data-type="appliance" data-item="dryer" id="room_4" data-space="4.04" height="262" width="262" y="480.34" x="297.57"/>'
            + '<path data-type="tree" data-item="" id="tree" d="m798.61,559.57a75.179,75.179,0,1,1,-150.36,0,75.179,75.179,0,1,1,150.36,0z" transform="translate(-34.213365,-44.117233)"/>'
            + '</svg>'
        },
        {
            id: "floor_id", // we ignore this for now just go with Level X
            title: "", // do we really need this ???
            svg: '<svg class="map map--5" viewBox="0 0 1200 800" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">'
            + '<title>Map Level 1</title>'
            + '<path data-type="outline" data-item="" d="m-1.8007-3.6014,0,773.4,1030.9,0,0-772.5z"/>'
            + '<rect data-type="floor" data-item="" id="floor" height="746.3" width="1005.4" y="9.6014" x="9.2028"/>'
            + '<rect data-type="room" data-item="" id="room_1" data-space="4.01" height="341.4" width="730.38" y="27.009" x="24.108"/>'
            + '<rect data-type="appliance" data-item="" id="room_2" data-space="4.02" height="440" width="160" y="301.49" x="838.39"/>'
            + '<rect data-type="lake" data-item="" id="room_3" data-space="4.03" height="262" width="262" y="480.19" x="21.306"/>'
            + '<rect data-type="appliance" data-item="dryer" id="room_4" data-space="4.04" height="262" width="262" y="480.34" x="297.57"/>'
            + '<path data-type="tree" data-item="" id="tree" d="m798.61,559.57a75.179,75.179,0,1,1,-150.36,0,75.179,75.179,0,1,1,150.36,0z" transform="translate(-34.213365,-44.117233)"/>'
            + '</svg>'
        },
        {
            id: "floor_id", // we ignore this for now just go with Level X
            title: "", // do we really need this ???
            svg: '<svg class="map map--5" viewBox="0 0 1200 800" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">'
            + '<title>Map Level 1</title>'
            + '<path data-type="outline" data-item="" d="m-1.8007-3.6014,0,773.4,1030.9,0,0-772.5z"/>'
            + '<rect data-type="floor" data-item="" id="floor" height="746.3" width="1005.4" y="9.6014" x="9.2028"/>'
            + '<rect data-type="room" data-item="" id="room_1" data-space="4.01" height="341.4" width="730.38" y="27.009" x="24.108"/>'
            + '<rect data-type="appliance" data-item="" id="room_2" data-space="4.02" height="440" width="160" y="301.49" x="838.39"/>'
            + '<rect data-type="lake" data-item="" id="room_3" data-space="4.03" height="262" width="262" y="480.19" x="21.306"/>'
            + '<rect data-type="appliance" data-item="dryer" id="room_4" data-space="4.04" height="262" width="262" y="480.34" x="297.57"/>'
            + '<path data-type="tree" data-item="" id="tree" d="m798.61,559.57a75.179,75.179,0,1,1,-150.36,0,75.179,75.179,0,1,1,150.36,0z" transform="translate(-34.213365,-44.117233)"/>'
            + '</svg>'
        },
        {
            id: "floor_id", // we ignore this for now just go with Level X
            title: "", // do we really need this ???
            svg: '<svg class="map map--5" viewBox="0 0 1200 800" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">'
            + '<title>Map Level 1</title>'
            + '<path data-type="outline" data-item="" d="m-1.8007-3.6014,0,773.4,1030.9,0,0-772.5z"/>'
            + '<rect data-type="floor" data-item="" id="floor" height="746.3" width="1005.4" y="9.6014" x="9.2028"/>'
            + '<rect data-type="room" data-item="" id="room_1" data-space="4.01" height="341.4" width="730.38" y="27.009" x="24.108"/>'
            + '<rect data-type="appliance" data-item="" id="room_2" data-space="4.02" height="440" width="160" y="301.49" x="838.39"/>'
            + '<rect data-type="lake" data-item="" id="room_3" data-space="4.03" height="262" width="262" y="480.19" x="21.306"/>'
            + '<rect data-type="appliance" data-item="dryer" id="room_4" data-space="4.04" height="262" width="262" y="480.34" x="297.57"/>'
            + '<path data-type="tree" data-item="" id="tree" d="m798.61,559.57a75.179,75.179,0,1,1,-150.36,0,75.179,75.179,0,1,1,150.36,0z" transform="translate(-34.213365,-44.117233)"/>'
            + '</svg>'
        },
        {
            id: "floor_id", // we ignore this for now just go with Level X
            title: "", // do we really need this ???
            svg: '<svg class="map map--5" viewBox="0 0 1200 800" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">'
            + '<title>Map Level 1</title>'
            + '<path data-type="outline" data-item="" d="m-1.8007-3.6014,0,773.4,1030.9,0,0-772.5z"/>'
            + '<rect data-type="floor" data-item="" id="floor" height="746.3" width="1005.4" y="9.6014" x="9.2028"/>'
            + '<rect data-type="room" data-item="" id="room_1" data-space="4.01" height="341.4" width="730.38" y="27.009" x="24.108"/>'
            + '<rect data-type="appliance" data-item="" id="room_2" data-space="4.02" height="440" width="160" y="301.49" x="838.39"/>'
            + '<rect data-type="lake" data-item="" id="room_3" data-space="4.03" height="262" width="262" y="480.19" x="21.306"/>'
            + '<rect data-type="appliance" data-item="dryer" id="room_4" data-space="4.04" height="262" width="262" y="480.34" x="297.57"/>'
            + '<path data-type="tree" data-item="" id="tree" d="m798.61,559.57a75.179,75.179,0,1,1,-150.36,0,75.179,75.179,0,1,1,150.36,0z" transform="translate(-34.213365,-44.117233)"/>'
            + '</svg>'
        },
    ]
};


$(function () {
    $.get('templates/level.html', function (data) {
        var template = Handlebars.compile(data),
            svg, type, item, appliance, pins = [], l, i;
        for (i = 0; i < building.floors.length; i++) {
            pins.length=0;
            l = i + 1;
            svg = $(building.floors[i].svg);
            $(svg).children().each(function (j) {
                var k = j + 1,
                    type = undefined,
                    appliance = undefined,
                    item = undefined;
                type = $(this).attr("data-type");
                if (type !== undefined && type !== null) {
                    switch (type) {
                        case 'appliance':
                        {
                            $(this).addClass('map__hidden');
                            item = $(this).attr("data-item");
                            appliance = $(this).attr("id");
                            if (item !== undefined && item !== null && item.length > 0
                                && appliance !== undefined && appliance !== null && appliance.length > 0) {
                                // TODO : create pin from template, add it, apply css
                                pins.push({
                                    appliance: appliance,
                                    level: l,
                                    marker: k,
                                    type: type,
                                    space: "4.01",          // TODO
                                    label: "Some Lable",    // TODO
                                    icon: "img/icons/tv.png"    // TODO
                                });
                            }
                            break;
                        }
                        case 'room':
                        {
                            $(this).addClass('map__space');
                            appliance = $(this).attr("id"); // this is the room id
                            if (appliance !== undefined && appliance !== null && appliance.length > 0) {
                                // TODO : create pin from template, add it, apply css
                                pins.push({
                                    appliance: appliance,
                                    level: l,
                                    marker: k,
                                    type: type,
                                    space: "4.01",          // TODO
                                    label: "Some Lable",    // TODO
                                    icon: "img/icons/default.png"    // TODO
                                });
                            }
                            break;
                        }
                        case 'floor':
                        {
                            $(this).addClass('map__ground');
                            break;
                        }
                        case 'outline':
                        {
                            $(this).addClass('map__outline');
                            break;
                        }
                        case 'tree':
                        {
                            $(this).addClass('map__tree');
                            break;
                        }
                        case 'lake':
                        {
                            $(this).addClass('map__lake');
                            break;
                        }
                        default:
                            break;
                    }
                }
            });
            $('.levels').append(template({
                svg: $("<div />").append($(svg).clone()).html(),
                pins: pins
            }));
        }
        var floors = $(".level");
        for (var i = 0; i < floors.length; i++) {
            var l = i + 1;
            var css_class = "level--" + l;
            var l_selector = "." + css_class;
            if (l > 1) {
                var h = i * (60 / floors.length);
                css.addRule(l_selector, "-webkit-transform: translateZ(" + h + "vmin); transform: translateZ(" + h + "vmin);");
                /* for (var j = i; j > 0; j--) {
                    css.addRule(".levels--selected-" + l + " .level--" + j, "-webkit-transform: translateZ(-60vmin); transform: translateZ(-60vmin);")
                }*/
            }
            css.addRule(l_selector + "::after", "content: 'L" + l + "';");
            css.addRule(".levels--selected-" + l + " .level:not(.level--" + l + ")", "opacity: 0;");
            css.addRule(".levels--selected-" + l, "-webkit-transition-delay: 0.25s; transition-delay: 0.25s;");
            css.addRule(".levels", "-webkit-transform:rotateX(70deg) rotateZ(-45deg) translateZ(-15vmin);transform:rotateX(70deg) rotateZ(-45deg) translateZ(-15vmin);");
            css.addRule(".level.level--current", "-webkit-transform:translateZ(15vmin) rotate3d(0, 0, 1, 20deg);;transform:translateZ(15vmin) rotate3d(0, 0, 1, 20deg);");
            $(floors[i]).addClass(css_class);
            $(floors[i]).attr("aria-label", "Level " + l);
            $(floors[i]).attr("data-level", l);
            $(".levels").show(0.15);
        }

        (function (window) {

            'use strict';

            // helper functions
            // from https://davidwalsh.name/vendor-prefix
            var prefix = (function () {
                var styles = window.getComputedStyle(document.documentElement, ''),
                    pre = (Array.prototype.slice.call(styles).join('').match(/-(moz|webkit|ms)-/) || (styles.OLink === '' && ['', 'o']))[1],
                    dom = ('WebKit|Moz|MS|O').match(new RegExp('(' + pre + ')', 'i'))[1];
                return {
                    dom: dom,
                    lowercase: pre,
                    css: '-' + pre + '-',
                    js: pre[0].toUpperCase() + pre.substr(1)
                };
            })();

            // vars & stuff
            var support = {transitions: Modernizr.csstransitions},
                transEndEventNames = {
                    'WebkitTransition': 'webkitTransitionEnd',
                    'MozTransition': 'transitionend',
                    'OTransition': 'oTransitionEnd',
                    'msTransition': 'MSTransitionEnd',
                    'transition': 'transitionend'
                },
                transEndEventName = transEndEventNames[Modernizr.prefixed('transition')],
                onEndTransition = function (el, callback, propTest) {
                    var onEndCallbackFn = function (ev) {
                        if (support.transitions) {
                            if (ev.target != this || propTest && ev.propertyName !== propTest && ev.propertyName !== prefix.css + propTest) return;
                            this.removeEventListener(transEndEventName, onEndCallbackFn);
                        }
                        if (callback && typeof callback === 'function') {
                            callback.call(this);
                        }
                    };
                    if (support.transitions) {
                        el.addEventListener(transEndEventName, onEndCallbackFn);
                    }
                    else {
                        onEndCallbackFn();
                    }
                },
            // the mall element
                mall = document.querySelector('.mall'),
            // mall´s levels wrapper
                mallLevelsEl = mall.querySelector('.levels'),
            // mall´s levels
                mallLevels = [].slice.call(mallLevelsEl.querySelectorAll('.level')),
            // total levels
                mallLevelsTotal = mallLevels.length,
            // surroundings elems
                mallSurroundings = [].slice.call(mall.querySelectorAll('.surroundings')),
            // selected level position
                selectedLevel,
            // navigation element wrapper
                mallNav = document.querySelector('.mallnav'),
            // show all mall´s levels ctrl
                allLevelsCtrl = mallNav.querySelector('.mallnav__button--all-levels'),
            // levels navigation up/down ctrls
                levelUpCtrl = mallNav.querySelector('.mallnav__button--up'),
                levelDownCtrl = mallNav.querySelector('.mallnav__button--down'),
            // pins
                pins = [].slice.call(mallLevelsEl.querySelectorAll('.pin')),
            // content element
                contentEl = document.querySelector('.content'),
            // content close ctrl
                contentCloseCtrl = contentEl.querySelector('button.content__button'),
            // check if a content item is opened
                isOpenContentArea,
            // check if currently animating/navigating
                isNavigating,
            // check if all levels are shown or if one level is shown (expanded)
                isExpanded,
            // spaces list element
                spacesListEl = document.getElementById('spaces-list'),
            // spaces list ul
                spacesEl = spacesListEl.querySelector('ul.list'),
            // all the spaces listed
                spaces = [].slice.call(spacesEl.querySelectorAll('.list__item > a.list__link')),
            // reference to the current shows space (name set in the data-name attr of both the listed spaces and the pins on the map)
                spaceref,
            // sort by ctrls
                sortByNameCtrl = document.querySelector('#sort-by-name'),
            // listjs initiliazation (all mall´s spaces)
                spacesList = new List('spaces-list', {valueNames: ['list__link', {data: ['level']}, {data: ['category']}]}),

            // smaller screens:
            // open search ctrl
                openSearchCtrl = document.querySelector('button.open-search'),
            // main container
                containerEl = document.querySelector('.container'),
            // close search ctrl
                closeSearchCtrl = spacesListEl.querySelector('button.close-search');

            function init() {
                // init/bind events
                initEvents();
            }

            /**
             * Initialize/Bind events fn.
             */
            function initEvents() {
                // click on a Mall´s level
                $(".levels").on("click", ".level", function () {
                    // shows this level
                    var level = $(this).attr("data-level");
                    showLevel(level);
                });

                // click on the show mall´s levels ctrl
                allLevelsCtrl.addEventListener('click', function () {
                    // shows all levels
                    showAllLevels();
                });

                // navigating through the levels
                levelUpCtrl.addEventListener('click', function () {
                    navigate('Down');
                });
                levelDownCtrl.addEventListener('click', function () {
                    navigate('Up');
                });

                // sort by name ctrl - add/remove category name (css pseudo element) from list and sorts the spaces by name
                sortByNameCtrl.addEventListener('click', function () {
                    if (this.checked) {
                        classie.remove(spacesEl, 'grouped-by-category');
                        spacesList.sort('list__link');
                    }
                    else {
                        classie.add(spacesEl, 'grouped-by-category');
                        spacesList.sort('category');
                    }
                });

                // hovering a pin / clicking a pin
                pins.forEach(function (pin) {
                    var contentItem = contentEl.querySelector('.content__item[data-space="' + pin.getAttribute('data-space') + '"]');

                    pin.addEventListener('mouseenter', function () {
                        if (!isOpenContentArea) {
                            classie.add(contentItem, 'content__item--hover');
                        }
                    });
                    pin.addEventListener('mouseleave', function () {
                        if (!isOpenContentArea) {
                            classie.remove(contentItem, 'content__item--hover');
                        }
                    });
                    pin.addEventListener('click', function (ev) {
                        ev.preventDefault();
                        // open content for this pin
                        openContent(pin.getAttribute('data-space'));
                        // remove hover class (showing the title)
                        classie.remove(contentItem, 'content__item--hover');
                    });
                });

                // closing the content area
                contentCloseCtrl.addEventListener('click', function () {
                    closeContentArea();
                });

                // clicking on a listed space: open level - shows space
                spaces.forEach(function (space) {
                    var spaceItem = space.parentNode,
                        level = spaceItem.getAttribute('data-level'),
                        spacerefval = spaceItem.getAttribute('data-space');

                    space.addEventListener('click', function (ev) {
                        ev.preventDefault();
                        // for smaller screens: close search bar
                        closeSearch();
                        // open level
                        showLevel(level);
                        // open content for this space
                        openContent(spacerefval);
                    });
                });

                // smaller screens: open the search bar
                openSearchCtrl.addEventListener('click', function () {
                    openSearch();
                });

                // smaller screens: close the search bar
                closeSearchCtrl.addEventListener('click', function () {
                    closeSearch();
                });
            }

            /**
             * Opens a level. The current level moves to the center while the other ones move away.
             */
            function showLevel(level) {
                if (isExpanded) {
                    return false;
                }

                // update selected level val
                selectedLevel = level;

                // control navigation controls state
                setNavigationState();

                classie.add(mallLevelsEl, 'levels--selected-' + selectedLevel);

                // the level element
                var levelEl = mallLevels[selectedLevel - 1];
                classie.add(levelEl, 'level--current');

                onEndTransition(levelEl, function () {
                    classie.add(mallLevelsEl, 'levels--open');

                    // show level pins
                    showPins();

                    isExpanded = true;
                }, 'transform');

                // hide surroundings element
                hideSurroundings();

                // show mall nav ctrls
                showMallNav();

                // filter the spaces for this level
                showLevelSpaces();
            }

            /**
             * Shows all Mall´s levels
             */
            function showAllLevels() {
                if (isNavigating || !isExpanded) {
                    return false;
                }
                isExpanded = false;

                classie.remove(mallLevels[selectedLevel - 1], 'level--current');
                classie.remove(mallLevelsEl, 'levels--selected-' + selectedLevel);
                classie.remove(mallLevelsEl, 'levels--open');

                // hide level pins
                removePins();

                // shows surrounding element
                showSurroundings();

                // hide mall nav ctrls
                hideMallNav();

                // show back the complete list of spaces
                spacesList.filter();

                // close content area if it is open
                if (isOpenContentArea) {
                    closeContentArea();
                }
            }

            /**
             * Shows all spaces for current level
             */
            function showLevelSpaces() {
                spacesList.filter(function (item) {
                    return item.values().level === selectedLevel.toString();
                });
            }

            /**
             * Shows the level´s pins
             */
            function showPins(levelEl) {
                var levelEl = levelEl || mallLevels[selectedLevel - 1];
                classie.add(levelEl.querySelector('.level__pins'), 'level__pins--active');

                css.addRule(".levels", "-webkit-transform:'';transform:''");
                css.addRule(".level.level--current", "-webkit-transform:'';transform:''");
                $('.levels').hide().show(0);

                var level, marker, appliance_id;
                $(levelEl).find(".pin").each(function () {
                    level = $(this).attr("data-level");
                    marker = $(this).attr("data-marker");
                    appliance_id = $(this).attr("data-appliance");



                    var parent_rect = $("#"+appliance_id).parent("svg")[0].getBoundingClientRect();
                    var rect = $("#"+appliance_id)[0].getBoundingClientRect();



                    var center = {
                        x: (rect.left - parent_rect.left) + (rect.width / 2),
                        y: (rect.top - parent_rect.top) + (rect.height / 2)
                    };
                    var pin_class = "pin--" + level + "-" + marker,
                        pin_selector = "." + pin_class;

                    css.addRule(pin_selector, "left: "+center.x+"px;top: "+center.y+"px;");
                    $(this).addClass(pin_class);
                });

                css.addRule(".levels", "-webkit-transform:rotateX(70deg) rotateZ(-45deg) translateZ(-15vmin);transform:rotateX(70deg) rotateZ(-45deg) translateZ(-15vmin);");
                css.addRule(".level.level--current", "-webkit-transform:translateZ(15vmin) rotate3d(0, 0, 1, 20deg);;transform:translateZ(15vmin) rotate3d(0, 0, 1, 20deg);");
                $('.levels').hide().show(0);
            }

            /**
             * Removes the level´s pins
             */
            function removePins(levelEl) {
                var levelEl = levelEl || mallLevels[selectedLevel - 1];
                classie.remove(levelEl.querySelector('.level__pins'), 'level__pins--active');
            }

            /**
             * Show the navigation ctrls
             */
            function showMallNav() {
                classie.remove(mallNav, 'mallnav--hidden');
            }

            /**
             * Hide the navigation ctrls
             */
            function hideMallNav() {
                classie.add(mallNav, 'mallnav--hidden');
            }

            /**
             * Show the surroundings level
             */
            function showSurroundings() {
                mallSurroundings.forEach(function (el) {
                    classie.remove(el, 'surroundings--hidden');
                });
            }

            /**
             * Hide the surroundings level
             */
            function hideSurroundings() {
                mallSurroundings.forEach(function (el) {
                    classie.add(el, 'surroundings--hidden');
                });
            }

            /**
             * Navigate through the mall´s levels
             */
            function navigate(direction) {
                if (isNavigating || !isExpanded || isOpenContentArea) {
                    return false;
                }
                isNavigating = true;

                var prevSelectedLevel = selectedLevel;

                // current level
                var currentLevel = mallLevels[prevSelectedLevel - 1];

                if (direction === 'Up' && prevSelectedLevel > 1) {
                    --selectedLevel;
                }
                else if (direction === 'Down' && prevSelectedLevel < mallLevelsTotal) {
                    ++selectedLevel;
                }
                else {
                    isNavigating = false;
                    return false;
                }

                // control navigation controls state (enabled/disabled)
                setNavigationState();
                // transition direction class
                classie.add(currentLevel, 'level--moveOut' + direction);
                // next level element
                var nextLevel = mallLevels[selectedLevel - 1];
                // ..becomes the current one
                classie.add(nextLevel, 'level--current');

                // when the transition ends..
                onEndTransition(currentLevel, function () {
                    classie.remove(currentLevel, 'level--moveOut' + direction);
                    // solves rendering bug for the SVG opacity-fill property
                    setTimeout(function () {
                        classie.remove(currentLevel, 'level--current');
                    }, 60);

                    classie.remove(mallLevelsEl, 'levels--selected-' + prevSelectedLevel);
                    classie.add(mallLevelsEl, 'levels--selected-' + selectedLevel);

                    // show the current level´s pins
                    showPins();

                    isNavigating = false;
                });

                // filter the spaces for this level
                showLevelSpaces();

                // hide the previous level´s pins
                removePins(currentLevel);
            }

            /**
             * Control navigation ctrls state. Add disable class to the respective ctrl when the current level is either the first or the last.
             */
            function setNavigationState() {
                if (selectedLevel == 1) {
                    classie.add(levelDownCtrl, 'boxbutton--disabled');
                }
                else {
                    classie.remove(levelDownCtrl, 'boxbutton--disabled');
                }

                if (selectedLevel == mallLevelsTotal) {
                    classie.add(levelUpCtrl, 'boxbutton--disabled');
                }
                else {
                    classie.remove(levelUpCtrl, 'boxbutton--disabled');
                }
            }

            /**
             * Opens/Reveals a content item.
             */
            function openContent(spacerefval) {
                // if one already shown:
                if (isOpenContentArea) {
                    hideSpace();
                    spaceref = spacerefval;
                    showSpace();
                }
                else {
                    spaceref = spacerefval;
                    openContentArea();
                }

                // remove class active (if any) from current list item
                var activeItem = spacesEl.querySelector('li.list__item--active');
                if (activeItem) {
                    classie.remove(activeItem, 'list__item--active');
                }
                // list item gets class active (if the list item is currently shown in the list)
                var listItem = spacesEl.querySelector('li[data-space="' + spacerefval + '"]');
                if (listItem) {
                    classie.add(listItem, 'list__item--active');
                }

                // remove class selected (if any) from current space
                var activeSpaceArea = mallLevels[selectedLevel - 1].querySelector('svg > .map__space--selected');
                if (activeSpaceArea) {
                    classie.remove(activeSpaceArea, 'map__space--selected');
                }
                // svg area gets selected
                classie.add(mallLevels[selectedLevel - 1].querySelector('svg > .map__space[data-space="' + spaceref + '"]'), 'map__space--selected');
            }

            /**
             * Opens the content area.
             */
            function openContentArea() {
                isOpenContentArea = true;
                // shows space
                showSpace(true);
                // show close ctrl
                classie.remove(contentCloseCtrl, 'content__button--hidden');
                // resize mall area
                classie.add(mall, 'mall--content-open');
                // disable mall nav ctrls
                classie.add(levelDownCtrl, 'boxbutton--disabled');
                classie.add(levelUpCtrl, 'boxbutton--disabled');
            }

            /**
             * Shows a space.
             */
            function showSpace(sliding) {
                // the content item
                var contentItem = contentEl.querySelector('.content__item[data-space="' + spaceref + '"]');
                // show content
                classie.add(contentItem, 'content__item--current');
                if (sliding) {
                    onEndTransition(contentItem, function () {
                        classie.add(contentEl, 'content--open');
                    });
                }
                // map pin gets selected
                classie.add(mallLevelsEl.querySelector('.pin[data-space="' + spaceref + '"]'), 'pin--active');
            }

            /**
             * Closes the content area.
             */
            function closeContentArea() {
                classie.remove(contentEl, 'content--open');
                // close current space
                hideSpace();
                // hide close ctrl
                classie.add(contentCloseCtrl, 'content__button--hidden');
                // resize mall area
                classie.remove(mall, 'mall--content-open');
                // enable mall nav ctrls
                if (isExpanded) {
                    setNavigationState();
                }
                isOpenContentArea = false;
            }

            /**
             * Hides a space.
             */
            function hideSpace() {
                // the content item
                var contentItem = contentEl.querySelector('.content__item[data-space="' + spaceref + '"]');
                // hide content
                classie.remove(contentItem, 'content__item--current');
                // map pin gets unselected
                classie.remove(mallLevelsEl.querySelector('.pin[data-space="' + spaceref + '"]'), 'pin--active');
                // remove class active (if any) from current list item
                var activeItem = spacesEl.querySelector('li.list__item--active');
                if (activeItem) {
                    classie.remove(activeItem, 'list__item--active');
                }
                // remove class selected (if any) from current space
                var activeSpaceArea = mallLevels[selectedLevel - 1].querySelector('svg > .map__space--selected');
                if (activeSpaceArea) {
                    classie.remove(activeSpaceArea, 'map__space--selected');
                }
            }

            /**
             * for smaller screens: open search bar
             */
            function openSearch() {
                // shows all levels - we want to show all the spaces for smaller screens
                showAllLevels();

                classie.add(spacesListEl, 'spaces-list--open');
                classie.add(containerEl, 'container--overflow');
            }

            /**
             * for smaller screens: close search bar
             */
            function closeSearch() {
                classie.remove(spacesListEl, 'spaces-list--open');
                classie.remove(containerEl, 'container--overflow');
            }

            init();

        })(window);


        /// -------------------------
    }, 'html');
});